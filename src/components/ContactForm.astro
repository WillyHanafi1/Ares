---
const challenges = [
    { value: "cs", label: "Customer Service Kewalahan (Balas Chat Lama)" },
    { value: "admin", label: "Administrasi & Input Data Manual" },
    { value: "leads", label: "Manajemen Leads / Penjualan" },
    { value: "cost", label: "Ingin Efisiensi Biaya Operasional" },
    { value: "other", label: "Lainnya" },
];

// Get environment variables (with fallbacks)
const webhookUrl =
    import.meta.env.PUBLIC_WEBHOOK_URL ||
    "https://n8n.seriaflow.com/webhook/Website-Leads-Seriaflow";
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || "";
---

<section
    id="kontak"
    class="relative py-24"
    data-webhook={webhookUrl}
    data-recaptcha={recaptchaSiteKey}
>
    <div class="mx-auto max-w-3xl px-6 lg:px-8">
        <div
            class="animate-on-scroll animate-scale glass-panel rounded-2xl p-8 md:p-12 relative overflow-hidden"
        >
            <!-- Gradient overlay -->
            <div
                class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-primary/5 to-transparent pointer-events-none"
            >
            </div>

            <div class="relative z-10">
                <!-- Header -->
                <div class="text-center mb-10">
                    <h2
                        class="animate-on-scroll animate-from-bottom text-3xl font-bold tracking-tight text-white mb-4"
                    >
                        Konsultasi Potensi AI untuk Bisnis Anda (Gratis)
                    </h2>
                    <p
                        class="animate-on-scroll animate-from-bottom animate-delay-100 text-gray-400"
                    >
                        Isi formulir di bawah ini untuk berdiskusi dengan tim
                        ahli kami.
                    </p>
                </div>

                <!-- Form -->
                <form id="contact-form" class="space-y-6">
                    <!-- Name -->
                    <div
                        class="animate-on-scroll animate-from-left animate-delay-100"
                    >
                        <label
                            for="name"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Nama Lengkap</label
                        >
                        <input
                            type="text"
                            id="name"
                            name="name"
                            placeholder="Contoh: Budi Santoso"
                            class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                        />
                    </div>

                    <!-- Business Name -->
                    <div
                        class="animate-on-scroll animate-from-right animate-delay-200"
                    >
                        <label
                            for="business"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Nama Bisnis / Perusahaan</label
                        >
                        <input
                            type="text"
                            id="business"
                            name="business"
                            placeholder="Contoh: Seriaflow Agency"
                            class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                        />
                    </div>

                    <!-- WhatsApp -->
                    <div
                        class="animate-on-scroll animate-from-left animate-delay-300"
                    >
                        <label
                            for="whatsapp"
                            class="block text-sm font-medium text-gray-300 mb-2"
                        >
                            Nomor WhatsApp (Aktif) <span class="text-red-500"
                                >*</span
                            >
                        </label>
                        <input
                            type="tel"
                            id="whatsapp"
                            name="whatsapp"
                            placeholder="0812xxxxxxxx (Pastikan nomor terhubung ke WA)"
                            required
                            class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                        />
                    </div>

                    <!-- Challenge Dropdown -->
                    <div
                        class="animate-on-scroll animate-from-right animate-delay-400"
                    >
                        <label
                            for="challenge"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Apa Tantangan Terbesar Anda?</label
                        >
                        <div class="relative">
                            <select
                                id="challenge"
                                name="challenge"
                                class="block w-full appearance-none rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all cursor-pointer"
                            >
                                <option value="" disabled selected
                                    >Pilih tantangan Anda</option
                                >
                                {
                                    challenges.map((item) => (
                                        <option value={item.value}>
                                            {item.label}
                                        </option>
                                    ))
                                }
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400"
                            >
                                <span class="material-symbols-outlined text-sm"
                                    >expand_more</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        id="submit-btn"
                        class="animate-on-scroll animate-from-bottom animate-delay-500 w-full flex items-center justify-center gap-2 rounded-lg bg-primary px-8 py-4 text-base font-bold text-white transition-all hover:bg-primary/90 hover:shadow-[0_0_20px_rgba(19,19,236,0.5)] mt-6"
                    >
                        <span class="material-symbols-outlined">send</span>
                        Kirim Data Saya
                    </button>

                    <!-- reCAPTCHA Notice -->
                    <p class="text-xs text-gray-500 text-center mt-4">
                        Dilindungi oleh reCAPTCHA.
                        <a
                            href="https://policies.google.com/privacy"
                            target="_blank"
                            class="underline hover:text-gray-400">Privacy</a
                        > &
                        <a
                            href="https://policies.google.com/terms"
                            target="_blank"
                            class="underline hover:text-gray-400">Terms</a
                        >
                    </p>
                </form>

                <!-- Success Message (hidden by default) -->
                <div id="success-message" class="hidden text-center py-8">
                    <div class="mb-6">
                        <span
                            class="material-symbols-outlined text-6xl text-green-400"
                            >check_circle</span
                        >
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-3">
                        Data Berhasil Dikirim! ðŸŽ‰
                    </h3>
                    <p class="text-gray-400 mb-4">
                        Terima kasih telah menghubungi kami.<br />
                        Tim kami akan segera menghubungi Anda via <strong
                            class="text-green-400">WhatsApp</strong
                        >.
                    </p>
                    <p class="text-sm text-gray-500">
                        Biasanya kami merespon dalam waktu 1x24 jam.
                    </p>
                    <button
                        id="reset-form-btn"
                        class="mt-6 px-6 py-2 rounded-lg border border-white/10 text-gray-300 hover:bg-white/5 transition-all"
                    >
                        Kirim Data Lagi
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    select option {
        background-color: #13132b;
        color: white;
    }
    /* Hide reCAPTCHA badge - we show text notice instead */
    .grecaptcha-badge {
        visibility: hidden !important;
    }
</style>

<!-- Load reCAPTCHA v3 Script -->
<script is:inline define:vars={{ recaptchaSiteKey }}>
    // Load reCAPTCHA script if site key exists
    if (recaptchaSiteKey && recaptchaSiteKey !== "your_site_key_here") {
        const script = document.createElement("script");
        script.src = `https://www.google.com/recaptcha/api.js?render=${recaptchaSiteKey}`;
        script.async = true;
        document.head.appendChild(script);
    }
</script>

<script>
    const section = document.getElementById("kontak");
    const form = document.getElementById("contact-form");
    const submitBtn = document.getElementById("submit-btn");
    const successMessage = document.getElementById("success-message");
    const resetFormBtn = document.getElementById("reset-form-btn");
    const originalBtnText = submitBtn?.innerHTML || "";

    // Get config from data attributes
    const webhookUrl = section?.dataset.webhook || "";
    const recaptchaSiteKey = section?.dataset.recaptcha || "";

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Show loading state
        if (submitBtn) {
            submitBtn.innerHTML =
                '<span class="material-symbols-outlined animate-spin">progress_activity</span> Mengirim...';
            submitBtn.setAttribute("disabled", "true");
        }

        const formData = new FormData(form as HTMLFormElement);
        const name = formData.get("name") || "";
        const business = formData.get("business") || "";
        const whatsapp = formData.get("whatsapp") || "";
        const challenge = formData.get("challenge") || "";

        // Get challenge label
        const challengeSelect = document.getElementById(
            "challenge",
        ) as HTMLSelectElement;
        const challengeLabel =
            challengeSelect?.options[challengeSelect.selectedIndex]?.text ||
            challenge;

        // Get reCAPTCHA token
        let recaptchaToken = "";
        if (
            recaptchaSiteKey &&
            recaptchaSiteKey !== "your_site_key_here" &&
            (window as any).grecaptcha
        ) {
            try {
                recaptchaToken = await (window as any).grecaptcha.execute(
                    recaptchaSiteKey,
                    { action: "submit_lead" },
                );
            } catch (error) {
                console.error("reCAPTCHA error:", error);
            }
        }

        // Prepare data for webhook
        const leadData = {
            name: name,
            business: business,
            whatsapp: whatsapp,
            challenge: challenge,
            challenge_label: challengeLabel,
            source: "website",
            submitted_at: new Date().toISOString(),
            recaptcha_token: recaptchaToken,
        };

        try {
            // Send data to n8n webhook
            await fetch(webhookUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(leadData),
            });

            // Show success message
            form.classList.add("hidden");
            successMessage?.classList.remove("hidden");
        } catch (error) {
            console.error("Webhook error:", error);
            // Still show success to user (don't block UX)
            form.classList.add("hidden");
            successMessage?.classList.remove("hidden");
        }

        // Reset button state for next time
        if (submitBtn) {
            submitBtn.innerHTML = originalBtnText;
            submitBtn.removeAttribute("disabled");
        }
    });

    // Reset form button
    resetFormBtn?.addEventListener("click", () => {
        (form as HTMLFormElement).reset();
        form?.classList.remove("hidden");
        successMessage?.classList.add("hidden");
    });
</script>
