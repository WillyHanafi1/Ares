---
const challenges = [
    { value: "cs", label: "Customer Service Kewalahan (Balas Chat Lama)" },
    { value: "admin", label: "Administrasi & Input Data Manual" },
    { value: "leads", label: "Manajemen Leads / Penjualan" },
    { value: "cost", label: "Ingin Efisiensi Biaya Operasional" },
    { value: "other", label: "Lainnya" },
];

// Get environment variables (with fallbacks)
const webhookUrl =
    import.meta.env.PUBLIC_WEBHOOK_URL ||
    "https://n8n.seriaflow.com/webhook/Website-Leads-Seriaflow";
const waNumber = import.meta.env.PUBLIC_WHATSAPP_NUMBER || "6285117623819";
---

<section
    id="kontak"
    class="relative py-24"
    data-webhook={webhookUrl}
    data-wa={waNumber}
>
    <div class="mx-auto max-w-3xl px-6 lg:px-8">
        <div
            class="animate-on-scroll animate-scale glass-panel rounded-2xl p-8 md:p-12 relative overflow-hidden"
        >
            <!-- Gradient overlay -->
            <div
                class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-primary/5 to-transparent pointer-events-none"
            >
            </div>

            <div class="relative z-10">
                <!-- Header -->
                <div class="text-center mb-10">
                    <h2
                        class="animate-on-scroll animate-from-bottom text-3xl font-bold tracking-tight text-white mb-4"
                    >
                        Konsultasi Potensi AI untuk Bisnis Anda (Gratis)
                    </h2>
                    <p
                        class="animate-on-scroll animate-from-bottom animate-delay-100 text-gray-400"
                    >
                        Isi formulir di bawah ini untuk berdiskusi dengan tim
                        ahli kami.
                    </p>
                </div>

                <!-- Form -->
                <form id="contact-form" class="space-y-6">
                    <!-- Name -->
                    <div
                        class="animate-on-scroll animate-from-left animate-delay-100"
                    >
                        <label
                            for="name"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Nama Lengkap</label
                        >
                        <input
                            type="text"
                            id="name"
                            name="name"
                            placeholder="Contoh: Budi Santoso"
                            class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                        />
                    </div>

                    <!-- Business Name -->
                    <div
                        class="animate-on-scroll animate-from-right animate-delay-200"
                    >
                        <label
                            for="business"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Nama Bisnis / Perusahaan</label
                        >
                        <input
                            type="text"
                            id="business"
                            name="business"
                            placeholder="Contoh: Seriaflow Agency"
                            class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                        />
                    </div>

                    <!-- WhatsApp -->
                    <div
                        class="animate-on-scroll animate-from-left animate-delay-300"
                    >
                        <label
                            for="whatsapp"
                            class="block text-sm font-medium text-gray-300 mb-2"
                        >
                            Nomor WhatsApp (Aktif) <span class="text-red-500"
                                >*</span
                            >
                        </label>
                        <input
                            type="tel"
                            id="whatsapp"
                            name="whatsapp"
                            placeholder="0812xxxxxxxx (Pastikan nomor terhubung ke WA)"
                            required
                            class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                        />
                    </div>

                    <!-- Challenge Dropdown -->
                    <div
                        class="animate-on-scroll animate-from-right animate-delay-400"
                    >
                        <label
                            for="challenge"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Apa Tantangan Terbesar Anda?</label
                        >
                        <div class="relative">
                            <select
                                id="challenge"
                                name="challenge"
                                class="block w-full appearance-none rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all cursor-pointer"
                            >
                                <option value="" disabled selected
                                    >Pilih tantangan Anda</option
                                >
                                {
                                    challenges.map((item) => (
                                        <option value={item.value}>
                                            {item.label}
                                        </option>
                                    ))
                                }
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400"
                            >
                                <span class="material-symbols-outlined text-sm"
                                    >expand_more</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        class="animate-on-scroll animate-from-bottom animate-delay-500 w-full flex items-center justify-center gap-2 rounded-lg bg-primary px-8 py-4 text-base font-bold text-white transition-all hover:bg-primary/90 hover:shadow-[0_0_20px_rgba(19,19,236,0.5)] mt-6"
                    >
                        <span class="material-symbols-outlined">chat</span>
                        Hubungi Saya via WhatsApp
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<style>
    select option {
        background-color: #13132b;
        color: white;
    }
</style>

<script>
    const section = document.getElementById("kontak");
    const form = document.getElementById("contact-form");
    const submitBtn = form?.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn?.innerHTML || "";

    // Get config from data attributes
    const webhookUrl = section?.dataset.webhook || "";
    const waNumber = section?.dataset.wa || "";

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Show loading state
        if (submitBtn) {
            submitBtn.innerHTML =
                '<span class="material-symbols-outlined animate-spin">progress_activity</span> Mengirim...';
            submitBtn.setAttribute("disabled", "true");
        }

        const formData = new FormData(form as HTMLFormElement);
        const name = formData.get("name") || "";
        const business = formData.get("business") || "";
        const whatsapp = formData.get("whatsapp") || "";
        const challenge = formData.get("challenge") || "";

        // Get challenge label
        const challengeSelect = document.getElementById(
            "challenge",
        ) as HTMLSelectElement;
        const challengeLabel =
            challengeSelect?.options[challengeSelect.selectedIndex]?.text ||
            challenge;

        // Prepare data for webhook
        const leadData = {
            name: name,
            business: business,
            whatsapp: whatsapp,
            challenge: challenge,
            challenge_label: challengeLabel,
            source: "website",
            submitted_at: new Date().toISOString(),
        };

        try {
            // Send data to n8n webhook
            await fetch(webhookUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(leadData),
            });
        } catch (error) {
            console.error("Webhook error:", error);
            // Continue even if webhook fails - don't block user
        }

        // Reset button
        if (submitBtn) {
            submitBtn.innerHTML =
                '<span class="material-symbols-outlined">check_circle</span> Terkirim!';
        }

        // Create WhatsApp message
        const message = `Halo Seriaflow! ðŸ‘‹

Saya ingin konsultasi mengenai potensi AI untuk bisnis saya.

ðŸ“‹ *Detail:*
â€¢ Nama: ${name}
â€¢ Bisnis: ${business}
â€¢ Tantangan: ${challengeLabel}

Mohon bantuannya! ðŸ™`;

        // Delay then open WhatsApp with pre-filled message
        setTimeout(() => {
            const waUrl = `https://wa.me/${waNumber}?text=${encodeURIComponent(message)}`;
            window.open(waUrl, "_blank");

            // Reset form and button after redirect
            (form as HTMLFormElement).reset();
            if (submitBtn) {
                submitBtn.innerHTML = originalBtnText;
                submitBtn.removeAttribute("disabled");
            }
        }, 1000);
    });
</script>
