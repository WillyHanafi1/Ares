---
const challenges = [
    { value: "cs", label: "Customer Service Kewalahan (Balas Chat Lama)" },
    { value: "admin", label: "Administrasi & Input Data Manual" },
    { value: "leads", label: "Manajemen Leads / Penjualan" },
    { value: "cost", label: "Ingin Efisiensi Biaya Operasional" },
    { value: "other", label: "Lainnya" },
];

// Country codes with flags and ISO codes
const countries = [
    { code: "62", iso: "ID", name: "Indonesia", flag: "ðŸ‡®ðŸ‡©" },
    { code: "1", iso: "US", name: "United States", flag: "ðŸ‡ºðŸ‡¸" },
    { code: "44", iso: "GB", name: "United Kingdom", flag: "ðŸ‡¬ðŸ‡§" },
    { code: "60", iso: "MY", name: "Malaysia", flag: "ðŸ‡²ðŸ‡¾" },
    { code: "65", iso: "SG", name: "Singapore", flag: "ðŸ‡¸ðŸ‡¬" },
    { code: "66", iso: "TH", name: "Thailand", flag: "ðŸ‡¹ðŸ‡­" },
    { code: "84", iso: "VN", name: "Vietnam", flag: "ðŸ‡»ðŸ‡³" },
    { code: "63", iso: "PH", name: "Philippines", flag: "ðŸ‡µðŸ‡­" },
    { code: "61", iso: "AU", name: "Australia", flag: "ðŸ‡¦ðŸ‡º" },
    { code: "81", iso: "JP", name: "Japan", flag: "ðŸ‡¯ðŸ‡µ" },
    { code: "82", iso: "KR", name: "South Korea", flag: "ðŸ‡°ðŸ‡·" },
    { code: "86", iso: "CN", name: "China", flag: "ðŸ‡¨ðŸ‡³" },
    { code: "91", iso: "IN", name: "India", flag: "ðŸ‡®ðŸ‡³" },
    { code: "49", iso: "DE", name: "Germany", flag: "ðŸ‡©ðŸ‡ª" },
    { code: "33", iso: "FR", name: "France", flag: "ðŸ‡«ðŸ‡·" },
    { code: "39", iso: "IT", name: "Italy", flag: "ðŸ‡®ðŸ‡¹" },
    { code: "34", iso: "ES", name: "Spain", flag: "ðŸ‡ªðŸ‡¸" },
    { code: "31", iso: "NL", name: "Netherlands", flag: "ðŸ‡³ðŸ‡±" },
    { code: "971", iso: "AE", name: "UAE", flag: "ðŸ‡¦ðŸ‡ª" },
    { code: "966", iso: "SA", name: "Saudi Arabia", flag: "ðŸ‡¸ðŸ‡¦" },
    { code: "90", iso: "TR", name: "Turkey", flag: "ðŸ‡¹ðŸ‡·" },
    { code: "7", iso: "RU", name: "Russia", flag: "ðŸ‡·ðŸ‡º" },
    { code: "55", iso: "BR", name: "Brazil", flag: "ðŸ‡§ðŸ‡·" },
    { code: "52", iso: "MX", name: "Mexico", flag: "ðŸ‡²ðŸ‡½" },
    { code: "27", iso: "ZA", name: "South Africa", flag: "ðŸ‡¿ðŸ‡¦" },
    { code: "234", iso: "NG", name: "Nigeria", flag: "ðŸ‡³ðŸ‡¬" },
    { code: "20", iso: "EG", name: "Egypt", flag: "ðŸ‡ªðŸ‡¬" },
    { code: "880", iso: "BD", name: "Bangladesh", flag: "ðŸ‡§ðŸ‡©" },
    { code: "92", iso: "PK", name: "Pakistan", flag: "ðŸ‡µðŸ‡°" },
    { code: "64", iso: "NZ", name: "New Zealand", flag: "ðŸ‡³ðŸ‡¿" },
];

// Get environment variables (with fallbacks)
const webhookUrl =
    import.meta.env.PUBLIC_WEBHOOK_URL ||
    "https://n8n.seriaflow.com/webhook/Website-Leads-Seriaflow";
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || "";
---

<section
    id="kontak"
    class="relative py-24"
    data-webhook={webhookUrl}
    data-recaptcha={recaptchaSiteKey}
>
    <div class="mx-auto max-w-3xl px-6 lg:px-8">
        <div
            class="animate-on-scroll animate-scale glass-panel rounded-2xl p-8 md:p-12 relative overflow-hidden"
        >
            <!-- Gradient overlay -->
            <div
                class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-primary/5 to-transparent pointer-events-none"
            >
            </div>

            <div class="relative z-10">
                <!-- Header -->
                <div class="text-center mb-10">
                    <h2
                        class="animate-on-scroll animate-from-bottom text-3xl font-bold tracking-tight text-white mb-4"
                    >
                        Konsultasi Potensi AI untuk Bisnis Anda (Gratis)
                    </h2>
                    <p
                        class="animate-on-scroll animate-from-bottom animate-delay-100 text-gray-400"
                    >
                        Isi formulir di bawah ini untuk berdiskusi dengan tim
                        ahli kami.
                    </p>
                </div>

                <!-- Form -->
                <form id="contact-form" class="space-y-6">
                    <!-- Name -->
                    <div
                        class="animate-on-scroll animate-from-left animate-delay-100"
                    >
                        <label
                            for="name"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Nama Lengkap</label
                        >
                        <input
                            type="text"
                            id="name"
                            name="name"
                            placeholder="Contoh: Budi Santoso"
                            class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                        />
                    </div>

                    <!-- Business Name -->
                    <div
                        class="animate-on-scroll animate-from-right animate-delay-200"
                    >
                        <label
                            for="business"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Nama Bisnis / Perusahaan</label
                        >
                        <input
                            type="text"
                            id="business"
                            name="business"
                            placeholder="Contoh: Seriaflow Agency"
                            class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                        />
                    </div>

                    <!-- WhatsApp with Country Code -->
                    <div
                        class="animate-on-scroll animate-from-left animate-delay-300"
                    >
                        <label
                            for="whatsapp"
                            class="block text-sm font-medium text-gray-300 mb-2"
                        >
                            Nomor WhatsApp (Aktif) <span class="text-red-500"
                                >*</span
                            >
                        </label>
                        <div class="flex gap-2">
                            <!-- Custom Country Code Dropdown -->
                            <div
                                class="relative w-36 flex-shrink-0 z-10"
                                id="custom-country-dropdown"
                            >
                                <input
                                    type="hidden"
                                    name="country_code"
                                    id="hidden-country-code"
                                    value="62"
                                />

                                <button
                                    type="button"
                                    id="dropdown-trigger"
                                    class="flex w-full items-center justify-between rounded-lg border border-white/10 bg-white/5 px-3 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary transition-all text-sm"
                                >
                                    <span
                                        id="selected-display"
                                        class="flex items-center gap-2"
                                    >
                                        <img
                                            src="https://flagcdn.com/w40/id.png"
                                            width="20"
                                            height="15"
                                            alt="ID"
                                            class="rounded-sm"
                                        />
                                        <span>+62</span>
                                    </span>
                                    <span
                                        class="material-symbols-outlined text-sm text-gray-400"
                                        >expand_more</span
                                    >
                                </button>

                                <div
                                    id="dropdown-options"
                                    class="hidden absolute top-full left-0 mt-2 w-72 max-h-60 overflow-y-auto rounded-lg border border-white/10 bg-[#0f0f25] shadow-xl z-50"
                                >
                                    <div
                                        class="sticky top-0 bg-[#0f0f25] p-2 border-b border-white/10"
                                    >
                                        <input
                                            type="text"
                                            id="country-search"
                                            placeholder="Cari negara..."
                                            class="w-full bg-white/5 text-white text-xs px-3 py-2 rounded border border-white/10 focus:outline-none focus:border-primary"
                                        />
                                    </div>

                                    <ul class="py-1">
                                        {
                                            countries.map((country) => (
                                                <li
                                                    class="country-option flex items-center gap-3 px-4 py-3 text-sm text-gray-300 hover:bg-primary/20 hover:text-white cursor-pointer transition-colors"
                                                    data-code={country.code}
                                                    data-iso={country.iso.toLowerCase()}
                                                    data-name={country.name}
                                                >
                                                    <img
                                                        src={`https://flagcdn.com/w40/${country.iso.toLowerCase()}.png`}
                                                        width="24"
                                                        height="18"
                                                        alt={country.iso}
                                                        class="rounded-sm"
                                                        loading="lazy"
                                                    />
                                                    <span class="font-mono text-gray-400">
                                                        +{country.code}
                                                    </span>
                                                    <span class="truncate flex-1 text-xs text-gray-500">
                                                        {country.name}
                                                    </span>
                                                </li>
                                            ))
                                        }
                                    </ul>
                                </div>
                            </div>

                            <!-- Phone Number Input -->
                            <input
                                type="tel"
                                id="whatsapp"
                                name="whatsapp"
                                placeholder="812xxxxxxxx"
                                required
                                class="block w-full rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                            />
                        </div>
                    </div>

                    <!-- Challenge Dropdown -->
                    <div
                        class="animate-on-scroll animate-from-right animate-delay-400"
                    >
                        <label
                            for="challenge"
                            class="block text-sm font-medium text-gray-300 mb-2"
                            >Apa Tantangan Terbesar Anda?</label
                        >
                        <div class="relative">
                            <select
                                id="challenge"
                                name="challenge"
                                class="block w-full appearance-none rounded-lg border border-white/10 bg-white/5 px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all cursor-pointer"
                            >
                                <option value="" disabled selected
                                    >Pilih tantangan Anda</option
                                >
                                {
                                    challenges.map((item) => (
                                        <option value={item.value}>
                                            {item.label}
                                        </option>
                                    ))
                                }
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400"
                            >
                                <span class="material-symbols-outlined text-sm"
                                    >expand_more</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        id="submit-btn"
                        class="animate-on-scroll animate-from-bottom animate-delay-500 w-full flex items-center justify-center gap-2 rounded-lg bg-primary px-8 py-4 text-base font-bold text-white transition-all hover:bg-primary/90 hover:shadow-[0_0_20px_rgba(19,19,236,0.5)] mt-6"
                    >
                        <span class="material-symbols-outlined">send</span>
                        Kirim Data Saya
                    </button>

                    <!-- reCAPTCHA Notice -->
                    <p class="text-xs text-gray-500 text-center mt-4">
                        Dilindungi oleh reCAPTCHA.
                        <a
                            href="https://policies.google.com/privacy"
                            target="_blank"
                            class="underline hover:text-gray-400">Privacy</a
                        > &
                        <a
                            href="https://policies.google.com/terms"
                            target="_blank"
                            class="underline hover:text-gray-400">Terms</a
                        >
                    </p>
                </form>

                <!-- Success Message (hidden by default) -->
                <div id="success-message" class="hidden text-center py-8">
                    <div class="mb-6">
                        <span
                            class="material-symbols-outlined text-6xl text-green-400"
                            >check_circle</span
                        >
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-3">
                        Data Berhasil Dikirim! ðŸŽ‰
                    </h3>
                    <p class="text-gray-400 mb-4">
                        Terima kasih telah menghubungi kami.<br />
                        Tim kami akan segera menghubungi Anda via <strong
                            class="text-green-400">WhatsApp</strong
                        >.
                    </p>
                    <p class="text-sm text-gray-500">
                        Biasanya kami merespon dalam waktu 1x24 jam.
                    </p>
                    <button
                        id="reset-form-btn"
                        class="mt-6 px-6 py-2 rounded-lg border border-white/10 text-gray-300 hover:bg-white/5 transition-all"
                    >
                        Kirim Data Lagi
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    select option {
        background-color: #13132b;
        color: white;
    }
    /* Hide reCAPTCHA badge - we show text notice instead */
    .grecaptcha-badge {
        visibility: hidden !important;
    }
    /* Custom scrollbar for dropdown */
    #dropdown-options::-webkit-scrollbar {
        width: 6px;
    }
    #dropdown-options::-webkit-scrollbar-track {
        background: #0f0f25;
    }
    #dropdown-options::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
    }
</style>

<!-- Load reCAPTCHA v3 Script -->
<script is:inline define:vars={{ recaptchaSiteKey }}>
    // Load reCAPTCHA script if site key exists
    if (recaptchaSiteKey && recaptchaSiteKey !== "your_site_key_here") {
        const script = document.createElement("script");
        script.src = `https://www.google.com/recaptcha/api.js?render=${recaptchaSiteKey}`;
        script.async = true;
        document.head.appendChild(script);
    }
</script>

<script>
    const section = document.getElementById("kontak");
    const form = document.getElementById("contact-form");
    const submitBtn = document.getElementById("submit-btn");
    const successMessage = document.getElementById("success-message");
    const resetFormBtn = document.getElementById("reset-form-btn");
    const originalBtnText = submitBtn?.innerHTML || "";

    // Get config from data attributes
    const webhookUrl = section?.dataset.webhook || "";
    const recaptchaSiteKey = section?.dataset.recaptcha || "";

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Show loading state
        if (submitBtn) {
            submitBtn.innerHTML =
                '<span class="material-symbols-outlined animate-spin">progress_activity</span> Mengirim...';
            submitBtn.setAttribute("disabled", "true");
        }

        const formData = new FormData(form as HTMLFormElement);
        const name = formData.get("name") || "";
        const business = formData.get("business") || "";
        const countryCode = formData.get("country_code") || "62";
        const phoneNumber = (formData.get("whatsapp") as string) || "";
        const challenge = formData.get("challenge") || "";

        // Format phone number: remove leading 0 if exists, then prepend country code
        let cleanedPhone = phoneNumber.replace(/\D/g, ""); // Remove non-digits
        if (cleanedPhone.startsWith("0")) {
            cleanedPhone = cleanedPhone.substring(1);
        }
        const whatsapp = `${countryCode}${cleanedPhone}`;

        // Get challenge label
        const challengeSelect = document.getElementById(
            "challenge",
        ) as HTMLSelectElement;
        const challengeLabel =
            challengeSelect?.options[challengeSelect.selectedIndex]?.text ||
            challenge;

        // Get country display text (from selected display)
        const countryDisplayEl = document.getElementById("selected-display");
        const countryText =
            countryDisplayEl?.textContent?.trim() || `+${countryCode}`;

        // Get reCAPTCHA token
        let recaptchaToken = "";
        if (
            recaptchaSiteKey &&
            recaptchaSiteKey !== "your_site_key_here" &&
            (window as any).grecaptcha
        ) {
            try {
                recaptchaToken = await (window as any).grecaptcha.execute(
                    recaptchaSiteKey,
                    { action: "submit_lead" },
                );
            } catch (error) {
                console.error("reCAPTCHA error:", error);
            }
        }

        // Prepare data for webhook
        const leadData = {
            name: name,
            business: business,
            whatsapp: whatsapp,
            country: countryText,
            challenge: challenge,
            challenge_label: challengeLabel,
            source: "website",
            submitted_at: new Date().toISOString(),
            recaptcha_token: recaptchaToken,
        };

        try {
            // Send data to n8n webhook
            await fetch(webhookUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(leadData),
            });

            // Show success message
            form.classList.add("hidden");
            successMessage?.classList.remove("hidden");
        } catch (error) {
            console.error("Webhook error:", error);
            // Still show success to user (don't block UX)
            form.classList.add("hidden");
            successMessage?.classList.remove("hidden");
        }

        // Reset button state for next time
        if (submitBtn) {
            submitBtn.innerHTML = originalBtnText;
            submitBtn.removeAttribute("disabled");
        }
    });

    // === Custom Country Dropdown Logic ===
    const dropdown = document.getElementById("custom-country-dropdown");
    const trigger = document.getElementById("dropdown-trigger");
    const optionsMenu = document.getElementById("dropdown-options");
    const hiddenInput = document.getElementById(
        "hidden-country-code",
    ) as HTMLInputElement;
    const selectedDisplay = document.getElementById("selected-display");
    const searchInput = document.getElementById(
        "country-search",
    ) as HTMLInputElement;
    const optionItems = document.querySelectorAll(".country-option");

    // Reset form button
    resetFormBtn?.addEventListener("click", () => {
        (form as HTMLFormElement).reset();
        form?.classList.remove("hidden");
        successMessage?.classList.add("hidden");

        // Reset country dropdown to Indonesia
        if (selectedDisplay) {
            selectedDisplay.innerHTML = `<img src="https://flagcdn.com/w40/id.png" width="20" height="15" alt="ID" class="rounded-sm"> <span>+62</span>`;
        }
        if (hiddenInput) {
            hiddenInput.value = "62";
        }
    });

    // Toggle Menu
    trigger?.addEventListener("click", (e) => {
        e.stopPropagation();
        optionsMenu?.classList.toggle("hidden");
        if (!optionsMenu?.classList.contains("hidden")) {
            searchInput?.focus();
        }
    });

    // Select Option
    optionItems.forEach((item) => {
        item.addEventListener("click", () => {
            const code = item.getAttribute("data-code");
            const iso = item.getAttribute("data-iso");

            // Update display
            if (selectedDisplay && iso && code) {
                selectedDisplay.innerHTML = `<img src="https://flagcdn.com/w40/${iso}.png" width="20" height="15" alt="${iso.toUpperCase()}" class="rounded-sm"> <span>+${code}</span>`;
            }

            // Update hidden input
            if (hiddenInput && code) {
                hiddenInput.value = code;
            }

            // Close menu
            optionsMenu?.classList.add("hidden");

            // Clear search
            if (searchInput) {
                searchInput.value = "";
                optionItems.forEach((opt) => {
                    (opt as HTMLElement).style.display = "flex";
                });
            }
        });
    });

    // Search functionality
    searchInput?.addEventListener("input", (e) => {
        const filter = (e.target as HTMLInputElement).value.toLowerCase();
        optionItems.forEach((item) => {
            const text = item.textContent?.toLowerCase() || "";
            (item as HTMLElement).style.display = text.includes(filter)
                ? "flex"
                : "none";
        });
    });

    // Close on click outside
    document.addEventListener("click", (e) => {
        if (dropdown && !dropdown.contains(e.target as Node)) {
            optionsMenu?.classList.add("hidden");
        }
    });
</script>
